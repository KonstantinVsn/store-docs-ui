<html>
<head>
  <title>Plugin Example</title>
  <meta charset="utf-8">
  <!-- STYLES -->
  <link rel="stylesheet" href="https://test.ukey.net.ua:3020/plugin/css/ukey-plugin-font.css" type="text/css"/>
  <link rel="stylesheet" href="https://test.ukey.net.ua:3020/plugin/css/ukey-plugin-loader.css" type="text/css"/>
  <link rel="stylesheet" href="https://test.ukey.net.ua:3020/plugin/css/ukey-plugin-window.css" type="text/css"/>
  <link rel="stylesheet" href="style.css" type="text/css"/>

  <!-- JS -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="../js/constants.js" type="text/javascript"></script>
  <script src="../js/plugin.js" type="text/javascript"></script>
</head>
<body>
<div class="ukey-example-body">
  <div class="ukey-example-wrapper">
    <div class="ukey-example-content">
      <div class="header">
        <a href="http://ukey.net.ua" class="logo" target="_blank">
          <img src="https://test.ukey.net.ua:3020/modules/core/client/img/brand/ukey-icon.png" alt="">
        </a>
        <h3>UKey</h3>
      </div>

      <form id="ukey-example-sign-form" class="ukey-example-sign-form" action="javascript: signFileWithAuth()">
        <div>
          <input type="submit" class="ukey-example-submit-btn" value="Підписати"/>
          <div class="ukey-example-group buffer-group">
            <input id="ukey-example-file" class="valid" type="file" autocomplete="off">
            <label>Файл для підпису</label>
          </div>
        </div>
        <span id="signing-message" name="error-message"></span>
        <div id="ukey-example-certificate-group" class="ukey-example-group certificate-group" hidden>
          <label>Сертифікат</label>
          <div id="ukey-example-certificate-details"></div>
        </div>
      </form>
    </div>
  </div>
</div>
</body>
<script>
  var signatureGroup = $("#ukey-example-signature-group"),
    fileInput = $("#ukey-example-file"),
    signingMessageSpan = $("#signing-message");

  var signFileWithAuth = function () {
    var file = fileInput[0].files[0];
    if (file) {
      signingMessageSpan.text("");
      signatureGroup.hide();

      var defaultConfiguration = {
        targetUrl: "https://test.ukey.net.ua:3020",
        //targetUrl: "http://localhost:3020",
        name: 'Test',
        identifier: 'Test',
        portalId: '1851da23-e2a8-4a3e-baa9-7cceed979fat',
        portalKey: '548618421630d8204fbb73b9b506d3cb4dc9810a16249d14c83fa5209f47e3ccc00590d7f20cc535ba6490057405ccb4'
      };

      var onSuccess = function (response) {
//        $.ajax({
//          url: defaultConfiguration.targetUrl + response.data.fileSignatures.signatures[0].url,
//          type: 'GET',
//          headers:  {
//            "Authorization": "Bearer " + localStorage.getItem("ukey_auth_token")
//          },
//          processData: false,
//          success: function(data) {
//            var blob = new Blob([data], { type: "application/x-binary" });
//            var downloadUrl = URL.createObjectURL(blob);
//            var a = document.createElement("a");
//            a.href = downloadUrl;
//            a.download = file.name + ".p7s";
//            document.body.appendChild(a);
//            a.click();
//          }
//        });

        var oReq = new XMLHttpRequest();
        oReq.open("GET", defaultConfiguration.targetUrl + response.data.fileSignatures.signatures[0].url, true);
        oReq.setRequestHeader("Authorization", "Bearer " + localStorage.getItem("ukey_auth_token"));
        oReq.responseType = "arraybuffer";

        oReq.onload = function (oEvent) {
            debugger;
          var arrayBuffer = oReq.response;

          // if you want to access the bytes:
          var byteArray = new Uint8Array(arrayBuffer);
          // ...

          // If you want to use the image in your DOM:
          //var tmpFile = new File([arrayBuffer], file.name + ".p7s", {type: "text/bin"});
          var blob = new Blob([arrayBuffer], { type: "text/bin" });
          var url = URL.createObjectURL(blob);
          var a = document.createElement("a");
          a.href = url;
          a.download = file.name + ".p7s";
          document.body.appendChild(a);
          a.click();

          // whatever...
        };
        oReq.send();

        console.log(response);
      };

      var onError = function (response) {
        signingMessageSpan.text(JSON.stringify(response));
        console.log(response);
      };

      UKeyPlugin.init(defaultConfiguration);
      UKeyPlugin.signDataModule.signFileWithAuth(file, onSuccess, onError);
    }
  };
</script>
</html>
